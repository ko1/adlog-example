name: aggregate-logs

on:
  workflow_run:
    workflows:
      - sample-one
      - sample-two
      - sample-three
    types:
      - completed

permissions:
  actions: read
  contents: read

jobs:
  aggregate:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch logs from sample workflows
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          workflows=("sample-one.yml" "sample-two.yml" "sample-three.yml")
          mkdir -p logs
          for wf in "${workflows[@]}"; do
            run_id=$(gh api "repos/${REPO}/actions/workflows/${wf}/runs" \
              -f per_page=1 \
              -f head_sha="${SHA}" \
              -f status=completed \
              --jq '.workflow_runs[0].id')
            if [ -z "${run_id}" ] || [ "${run_id}" = "null" ]; then
              echo "No completed run found for ${wf}"
              continue
            fi
            echo "Downloading logs for ${wf} (run ${run_id})"
            gh api "repos/${REPO}/actions/runs/${run_id}/logs" --output "logs/${wf}.zip"
            unzip -q "logs/${wf}.zip" -d "logs/${wf}"
            echo "---- ${wf} logs ----"
            find "logs/${wf}" -type f -maxdepth 2 -print -exec cat {} \;
            echo "--------------------"
          done
