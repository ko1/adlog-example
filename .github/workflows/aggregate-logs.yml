name: aggregate-logs

on:
  workflow_run:
    workflows:
      - sample-one
      - sample-two
      - sample-three
    types:
      - completed

permissions:
  actions: read
  contents: read

jobs:
  aggregate:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch logs from sample workflows
        env:
          GH_TOKEN: ${{ secrets.ADLOGS_GH_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          if [ -z "${GH_TOKEN:-}" ]; then
            GH_TOKEN="${GITHUB_TOKEN}"
          fi
          export GH_TOKEN
          echo "GH token present: ${GH_TOKEN:+yes}"
          gh api "repos/${REPO}" --jq '.full_name' || echo "Repo check failed"
          gh api "repos/${REPO}/actions/runs" --jq '.total_count' || echo "Runs list failed"
          workflow_names=("sample-one" "sample-two" "sample-three")
          mkdir -p logs
          runs_json=$(gh api "repos/${REPO}/actions/runs" -f per_page=100 -f head_sha="${SHA}" -f status=completed)
          for wf_name in "${workflow_names[@]}"; do
            run_id=$(echo "${runs_json}" | jq -r ".workflow_runs[] | select(.name == \"${wf_name}\") | .id" | head -n 1)
            if [ -z "${run_id}" ] || [ "${run_id}" = "null" ]; then
              echo "No completed run found for ${wf_name}"
              continue
            fi
            echo "Downloading logs for ${wf_name} (run ${run_id})"
            gh api "repos/${REPO}/actions/runs/${run_id}" --jq '.id' || echo "Run lookup failed for ${run_id}"
            if ! gh run view "${run_id}" --repo "${REPO}" --log > "logs/${wf_name}.log"; then
              echo "Failed to download logs for ${wf_name}"
              continue
            fi
            echo "---- ${wf_name} logs ----"
            cat "logs/${wf_name}.log"
            echo "--------------------"
          done
